<!-- tasks/photos_page.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Photos Page</title>
    <style>
      body {
        background-color: #ffffff;
        color: #333;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }

      h1 {
        text-align: center;
        color: #000000;
      }

      .photo-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      .task-photo-container {
        position: relative;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .task-photo {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        display: block;
      }

      .delete-button {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #000000;
        color: #ffffff;
        border: none;
        border-radius: 50%;
        padding: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .delete-button:hover {
        background-color: #333333;
      }

      .preview-photo {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-top: 10px;
      }

      .file-input {
        display: none;
      }

      .choose-more-button {
        background-color: #000000;
        color: #ffffff;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 20px;
        transition: background-color 0.3s;
      }

      .choose-more-button:hover {
        background-color: #333333;
      }

      .add-photos-button {
        background-color: #000000;
        color: #ffffff;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        transition: background-color 0.3s;
      }

      .add-photos-button:hover {
        background-color: #333333;
      }
    </style>
  </head>
  <body>
    <h1>Task Photos Page</h1>

    <div id="photo-container" class="photo-container">
      <!-- Photos will be rendered here dynamically -->
    </div>

    <input
      type="file"
      id="fileInput"
      class="file-input"
      accept="image/*"
      multiple
      onchange="handleFileSelection()"
    />

    <button class="choose-more-button" onclick="openFileInput()">
      Choose More Photos
    </button>

    <button class="add-photos-button" onclick="uploadPhotos()">
      Add Photos
    </button>

    <div id="previewContainer"></div>

    <script>
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + "=")) {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      const csrfToken = getCookie("csrftoken");
      const fileInput = document.getElementById("fileInput");
      const previewContainer = document.getElementById("previewContainer");
      const urlParams = new URLSearchParams(window.location.search);
      const taskID = urlParams.get("taskID");

      function openFileInput() {
        fileInput.click();
      }

      function handleFileSelection() {
        // Clear existing preview
        previewContainer.innerHTML = "";

        const files = fileInput.files;

        for (const file of files) {
          // Create preview elements
          const previewPhoto = document.createElement("img");
          previewPhoto.src = URL.createObjectURL(file);
          previewPhoto.alt = "Selected Photo";
          previewPhoto.classList.add("preview-photo");

          // Append preview to container
          previewContainer.appendChild(previewPhoto);
        }
      }

      async function uploadPhotos() {
        const files = fileInput.files;

        if (files.length === 0) {
          alert("Please choose one or more photos.");
          return;
        }

        const formData = new FormData();
        for (const file of files) {
          formData.append("photos", file);
        }

        // Get the taskID from the URL parameters

        // Add the taskID to the formData
        formData.append("taskID", taskID);

        // Call the API to save photos
        try {
          const response = await fetch(`/photos/`, {
            method: "POST",
            body: formData,
            headers: {
              "X-CSRFToken": csrfToken,
            },
          });

          if (response.ok) {
            // Clear the file input and preview after successful upload
            fileInput.value = null;
            previewContainer.innerHTML = "";

            // Fetch and render updated photos
            fetchAndRenderPhotos();
          } else {
            console.error("Error uploading photos:", response.statusText);
          }
        } catch (error) {
          console.error("Error uploading photos:", error);
        }
      }

      async function fetchAndRenderPhotos() {
        // Fetch and render photos after uploading
        try {
          const response = await fetch(`/photos/${taskID}/`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
          });
          const photos = await response.json();

          // Render photos
          const photoContainer = document.getElementById("photo-container");
          photoContainer.innerHTML = ""; // Clear existing photos

          photos.forEach((photo) => {
            const photoContainerDiv = document.createElement("div");
            photoContainerDiv.classList.add("task-photo-container");

            const imgElement = document.createElement("img");
            imgElement.src = photo.image;
            imgElement.alt = "Task Photo";
            imgElement.classList.add("task-photo");

            const deleteButton = document.createElement("button");
            deleteButton.classList.add("delete-button");
            deleteButton.innerHTML = "&#10006;"; // Unicode for 'âœ–'

            deleteButton.addEventListener("click", async () => {
              // Call the delete photo API
              try {
                const deleteResponse = await fetch(
                  `/photos/${taskID}/${photo.id}/`,
                  {
                    method: "DELETE",
                    headers: {
                      "Content-Type": "application/json",
                      "X-CSRFToken": csrfToken,
                    },
                  }
                );

                if (deleteResponse.ok) {
                  // Remove the photo from the UI
                  photoContainerDiv.remove();
                } else {
                  console.error(
                    "Error deleting photo:",
                    deleteResponse.statusText
                  );
                }
              } catch (error) {
                console.error("Error deleting photo:", error);
              }
            });

            photoContainerDiv.appendChild(imgElement);
            photoContainerDiv.appendChild(deleteButton);

            photoContainer.appendChild(photoContainerDiv);
          });
        } catch (error) {
          console.error("Error fetching photos:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        // Get the taskID from the URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const taskID = urlParams.get("taskID");

        // Fetch and render initial photos
        await fetchAndRenderPhotos();
      });
    </script>
  </body>
</html>
